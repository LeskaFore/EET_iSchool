<!DOCTYPE html>
<!-- <svg width="960" height="1100"></svg> -->
<style>
#map {
  width: 960px;
  height: 500px;
}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
 <div id="map"></div>
<script>

var map = new L.Map("map")
	.setView([47.1, -122.8], 11);

var base = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

createFC('HWP.json');
//createWFC('HF.json');

// // specify the basemap and overlays to put in the layers control
// var baseMaps = {
//     "base": base,
// };

// var overlayMaps = {
//     "HWP": HWP,
//     "HF": zip
// };

// // initialize up the L.control.layers
// L.control.layers(baseMaps, overlayMaps).addTo(map);

// https://gist.github.com/onderaltintas/6649521
var meters2degress = function(x,y) {
        var lon = x *  180 / 20037508.34 ;
        var lat = Math.atan(Math.exp(y * Math.PI / 20037508.34)) * 360 / Math.PI - 90;
        return [lon, lat]
}

// x = -8575605.398444
// y = 4707174.018280

// console.log(meters2degress(x,y))


// load file
function loadProjects(filename){
    var promise = $.getJSON(filename);
    return promise.then(parseProjects);
};

// test = [
//                 [
//                     [-13671690.483103063, 5971192.183614647],
//                     [-13671740.11082264, 5971126.541129493]
//                 ]
//         ]
// console.log(test[0])

function parseProjects(json) {
    var features_array = [];
    var data = json.features;
    data.forEach(function(item){

        var project = {
            type: item.type,
            properties: {
                Project_ID: item.properties.Project_Nu,
                Project_Name: item.properties.Project_Na,
                Activity_Type: item.properties.Activity_T,
                Organization: item.properties.Organizati,
                Status: item.properties.Status,
                URL: item.properties.URL
                },
            geometry: {
                type: item.geometry.type,
                //coordinates: [Number(item.properties.Long), Number(item.properties.Lat)]
                //coordinates: [item.properties.Long, item.properties.Lat]
                coordinates: []
                },
            };
            var coords_list = item.geometry.coordinates[0];
            var lolt_array = [];
            // console.log(coords_list)
            coords_list.forEach(function(crds){
                var x = crds[0]
                var y = crds[1]
                var lolt = meters2degress(x,y)
                //console.log(lolt)
                
                lolt_array.push(lolt);
                
                //coords.forEach(function)(){};
                
            });
            project.geometry.coordinates.push(lolt_array);
        
        features_array.push(project);
    });
     console.log(features_array)
    return features_array; 
};


function createFC(filename){
   var promiseA = loadProjects(filename);
   
    $.when(promiseA).then(function(features_array) {
        var FeatCol = {}; 
            FeatCol.type = "FeatureCollection",
            FeatCol.features = features_array;
      //console.log(FeatCol)
      return FeatCol;

    }).then(function(data){

      new L.geoJson(data, {
        onEachFeature: function (feature, layer) {
        layer.bindPopup(feature.properties.Project_Name);
        },
        color: "red"
      }).addTo(map);

    });
};


</script>